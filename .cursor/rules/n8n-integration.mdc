---
description: n8n webhook triggers and ingest integration patterns
globs:
  - lib/n8n.ts
  - app/api/**/ingest/route.ts
  - app/api/**/trigger/route.ts
alwaysApply: false
---

# n8n Integration

When adding features that are triggered by or ingest data from n8n:

## Webhook URL pattern

- `N8N_BASE_URL` (in `.env.local`) controls which n8n instance all webhooks target. Change it to switch between local and n8n Cloud.
- Use `n8nWebhookUrl(path)` from `lib/n8n.ts` to build webhook URLs: `n8nWebhookUrl('clg-outreach-gen')` produces `${N8N_BASE_URL}/webhook/clg-outreach-gen`.
- Per-workflow env vars (e.g. `N8N_VEP001_WEBHOOK_URL`) override the base URL when set. Use them for workflows with instance-specific paths (e.g. UUID-based chat trigger).

## Environment variables

- Add a dedicated webhook URL env var per workflow (e.g. `N8N_VEP001_WEBHOOK_URL`, `N8N_VEP002_WEBHOOK_URL`).
- Use `n8nWebhookUrl('path')` as the fallback so the workflow automatically follows `N8N_BASE_URL`.
- Document the var in `.env.local` or project docs; trigger code should check for presence and skip or warn when unset.

## Trigger functions

- Add a trigger function in `lib/n8n.ts` that `fetch()`es the workflow webhook URL with the required payload.
- Use POST with `Content-Type: application/json`; pass any filters (industry, contactSubmissionId, etc.) in the body.
- Return `{ triggered: boolean, message?: string }` so callers can show feedback.

## Ingest endpoints

- Create a POST route (e.g. `app/api/admin/.../ingest/route.ts`) that accepts the payload from n8n.
- Authenticate using a **Bearer token** and a shared secret (e.g. `N8N_INGEST_SECRET`), not session-based auth.
- Validate required fields and return 400 with clear error messages; on success return 200 with a summary (e.g. counts inserted).
- Match the pattern used in `app/api/admin/outreach/ingest/route.ts` for consistency.

## API trigger route

- If the admin UI needs to start a workflow manually, add a route (e.g. `.../trigger/route.ts`) protected by `verifyAdmin`, which then calls the `lib/n8n.ts` trigger function and returns the result.
